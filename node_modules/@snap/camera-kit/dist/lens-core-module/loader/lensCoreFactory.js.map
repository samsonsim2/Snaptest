{"version":3,"file":"lensCoreFactory.js","sourceRoot":"","sources":["../../../src/lens-core-module/loader/lensCoreFactory.ts"],"names":[],"mappings":"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","sourcesContent":["import lensCoreWasm from \"../../lensCoreWasmVersions\";\nimport type { CameraKitConfiguration } from \"../../configuration\";\nimport { configurationToken } from \"../../configuration\";\nimport { Injectable } from \"../../dependency-injection/Injectable\";\nimport type { FetchHandler } from \"../../handlers/defaultFetchHandler\";\nimport { defaultFetchHandlerFactory } from \"../../handlers/defaultFetchHandler\";\nimport type { InitialEmscriptenModule, LensCoreModule } from \"../generated-types\";\nimport { getLogger } from \"../../logger/logger\";\nimport { createLensCore } from \"../lensCore\";\nimport { loadScript } from \"../../common/loadScript\";\nimport { HandlerChainBuilder } from \"../../handlers/HandlerChainBuilder\";\nimport { createCustomLensCoreHandler } from \"../../handlers/customLensCoreHandler\";\nimport { getRequiredBootstrapURLs } from \"./bootstrapURLs\";\n\nconst logger = getLogger(\"lensCoreFactory\");\n\nconst findMatch = (regex: RegExp, strings: string[]) => strings.find((s) => regex.test(s));\n\n/**\n * This component is responsible for:\n *   1) Loading LensCore WebAssembly (WASM) assets\n *   2) Using the WASM assets to initialize the LensCore WASM module\n *\n * By default, WASM assets will be loaded from the Bolt CDN â€“ but if `endpoint` is provided, assets will be loaded\n * using it as a base URL.\n *\n * @internal\n */\nexport const lensCoreFactory = Injectable(\n    \"lensCore\",\n    [defaultFetchHandlerFactory.token, configurationToken] as const,\n    async (handler: FetchHandler, { lensCoreOverrideUrls, wasmEndpointOverride }: CameraKitConfiguration) => {\n        let lensCoreJS: string;\n        let lensCoreWASM: string;\n        // We only use custom handler when LensCore is loaded from a custom location.\n        let lensCoreHandler =\n            lensCoreOverrideUrls || wasmEndpointOverride\n                ? new HandlerChainBuilder(handler).map(createCustomLensCoreHandler()).handler\n                : handler;\n\n        if (lensCoreOverrideUrls) {\n            lensCoreJS = lensCoreOverrideUrls.js;\n            lensCoreWASM = lensCoreOverrideUrls.wasm;\n        } else {\n            const endpointOverride = wasmEndpointOverride ?? undefined;\n            const assetURLs = await getRequiredBootstrapURLs(endpointOverride);\n\n            lensCoreJS = findMatch(/\\.js/, assetURLs) ?? \"\";\n            lensCoreWASM = findMatch(/\\.wasm/, assetURLs) ?? \"\";\n\n            if (!lensCoreJS || !lensCoreWASM) {\n                throw new Error(\n                    `Cannot fetch required LensCore assets. Either the JS or WASM filename is missing from ` +\n                        `this list: ${assetURLs}.`\n                );\n            }\n\n            // Fetching here and creating an Object URL lets LensCore optimized loading itself in a WebWorker,\n            // otherwise the glue script would need to be downloaded again.\n            const glueScript = await lensCoreHandler(lensCoreJS).then((r) => r.blob());\n            lensCoreJS = URL.createObjectURL(glueScript);\n        }\n\n        const scriptElement = await loadScript(lensCoreJS);\n\n        const lensCore = await new Promise<InitialEmscriptenModule & LensCoreModule>((resolve, reject) => {\n            let initialModule: Partial<InitialEmscriptenModule>;\n            // will trigger WASM initialization and data loading,\n            // after completion it will be safe to call imported WASM functions\n            // More about emscripten initialization:\n            // eslint-disable-next-line max-len\n            // https://emscripten.org/docs/getting_started/FAQ.html?highlight=modularize#how-can-i-tell-when-the-page-is-fully-loaded-and-it-is-safe-to-call-compiled-functions\n            const moduleInit = globalThis.createLensesModule(\n                (initialModule = {\n                    // url will be used for loading glue JS during Worker initialization\n                    mainScriptUrlOrBlob: lensCoreJS,\n                    // will be triggered by Emscripten during the initialization\n                    instantiateWasm: (importObject, receiveInstance) => {\n                        WebAssembly.instantiateStreaming(lensCoreHandler(lensCoreWASM), importObject)\n                            .then(function ({ instance, module }) {\n                                receiveInstance(instance, module);\n                                // compiled module will be reused in Worker\n                                initialModule.compiledModule = module;\n                                resolve(moduleInit);\n                            })\n                            .catch(reject);\n                    },\n                })\n            );\n        });\n\n        // now when we have LensCore WASM in memory we can release the script element\n        scriptElement.remove();\n\n        // print warning if loaded version differs from hardcoded one\n        if (lensCoreWasm.version != `${lensCore.getCoreVersion()}`) {\n            logger.warn(\n                `Loaded LensCore version (${lensCore.getCoreVersion()}) differs from expected one (${\n                    lensCoreWasm.version\n                })`\n            );\n        }\n\n        return createLensCore(lensCore);\n    }\n);\n"]}